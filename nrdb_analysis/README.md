# NRDB Analysis Pack ðŸ“Š

Reusable NRQL snippets & dashboard JSON to verify ingest savings, identify noisy processes, and assist with manual validation after deploying configuration changes generated by `process-lab`.

*   **Note:** The `process-lab validate` command is currently stubbed. Use these queries for manual verification.

| File                             | Purpose                                                          |
|----------------------------------|------------------------------------------------------------------|
| `measure_ingest_cost.nrql`       | Billable GB/day + $ cost projection from `NrConsumption`         |
| `find_noisy_processes.nrql`      | Top 200 PIDs by sample count & `bytecountestimate()`             |
| `validate_template_impact.nrql`  | CPU/Mem/Count coverage check for specific host after deployment  |
| `tier1_visibility_check.nrql`    | Check if specific critical processes are reporting               |
| `infra_lab_cost_overview.json`   | Example Dashboard JSON definition for import into New Relic      |

## 1. Usage Examples

### Check Actual Ingest Cost

Use `measure_ingest_cost.nrql` in the New Relic Query Builder:

```sql
-- File: measure_ingest_cost.nrql
FROM NrConsumption
SELECT sum(GigabytesIngested) * 0.35 AS 'EstimatedMonthlyUSD' -- Adjust multiplier for your price/GB
WHERE productLine = 'DataPlatform' AND usageMetric = 'Data Platform Bytes'
SINCE 1 day ago
FACET consumingAccountName, usageMetric
TIMESERIES 1 hour
```

### Check Visibility After Deployment

Use `validate_template_impact.nrql`, replacing the hostname placeholder:

```sql
-- File: validate_template_impact.nrql
SELECT uniqueCount(processId) as 'Process Count', average(cpuPercent) as 'Avg CPU %', percentile(memoryResidentSizeBytes, 95) as 'Mem RSS P95'
FROM ProcessSample
WHERE hostname = 'YOUR_HOSTNAME_HERE' -- Replace with host where config was deployed
SINCE 30 minutes AGO TIMESERIES
```

### Check Tier-1 Process Visibility

Use `tier1_visibility_check.nrql`, modifying the process list as needed:

```sql
-- File: tier1_visibility_check.nrql
FROM ProcessSample
SELECT uniqueCount(entityGuid) as 'Hosts Reporting'
WHERE processDisplayName IN ('nginx', 'java', 'mysqld', 'postgres', 'node', 'python') -- Add/Remove critical processes
SINCE 1 hour AGO
FACET processDisplayName
LIMIT MAX
```

## 2. Dashboard

The `infra_lab_cost_overview.json` file contains a JSON definition for a New Relic dashboard.

To Import:

1.  Go to Dashboards in New Relic One.
2.  Click **Import dashboard**.
3.  Paste the contents of `infra_lab_cost_overview.json` into the JSON field.
4.  Adjust Account ID and permissions as needed.

The dashboard provides widgets for:

*   GB/day trend (based on `bytecountestimate()`)
*   Estimated cost vs. target budget (requires manual target setting)
*   Top processes by data volume
*   Process count trends

(Note: Dashboard widgets may need adjustments based on your specific account structure and data.)